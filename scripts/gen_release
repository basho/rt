echo "===> Running post_compile hook for generating Riak release"
# TODO check if target files are already there and only generate release if there the files are NOT there
# TARGET_DIR="priv/bin/$REBAR_PROFILE"
# if [ -d "priv/bin/$REBAR_PROFILE" ]; then
#   # Control will enter here if $DIRECTORY exists.
#   echo "Release artefact directory already exists. Checking for binaries"
#   if [ ! -f "$TARGET_DIR/" ]; then
#     echo "File not found!"
#   fi
# fi
CWD=$(pwd)
OLD_DEPS_DIR=$REBAR_DEPS_DIR
OLD_BUILD_DIR=$REBAR_BUILD_DIR
echo "REBAR_PROFILE = $REBAR_PROFILE"
echo "REBAR_DEPS_DIR = $REBAR_DEPS_DIR"
echo "REBAR_BUILD_DIR = $REBAR_BUILD_DIR"
echo "REBAR_ROOT_DIR = $REBAR_ROOT_DIR"
echo "REBAR_CHECKOUTS_DIR = $REBAR_CHECKOUTS_DIR"
echo "REBAR_PLUGINS_DIR = $REBAR_PLUGINS_DIR"
echo "REBAR_GLOBAL_CONFIG_DIR = $REBAR_GLOBAL_CONFIG_DIR"
echo "REBAR_GLOBAL_CACHE_DIR = $REBAR_GLOBAL_CACHE_DIR"
echo "REBAR_TEMPLATE_DIR = $REBAR_TEMPLATE_DIR"
echo "REBAR_APP_DIRS = $REBAR_APP_DIRS"
echo "REBAR_SRC_DIRS = $REBAR_SRC_DIRS"
echo "ERLANG_ERTS_VER = $ERLANG_ERTS_VER"
echo "ERLANG_ROOT_DIR = $ERLANG_ROOT_DIR"
echo "ERL = $ERL"
echo "ERLC = $ERLC"
echo "ERLANG_ARCH = $ERLANG_ARCH"
echo "ERLANG_TARGET = $ERLANG_TARGET"
echo "Post compile hook: Changing directory into Riak dependency..."
cd $REBAR_DEPS_DIR/riak
echo "Post compile hook: Working from $(pwd)..."
echo "Post compile hook: Set REBAR_DEPS_DIR to $(pwd)/deps"
echo "Post compile hook: Set REBAR_BUILD_DIR to $(pwd)/rel"
REBAR_DEPS_DIR=$(pwd)/deps
REBAR_BUILD_DIR=$(pwd)/rel
echo "Post compile hook: Generating manual Riak release..."
make all devrel
if [ $? -eq 0 ]; then
    echo "Post compile hook: Done generating release."
    cd $CWD
    echo "Post compile hook: Copying artefacts to shared directory..."
    if [ -z $REBAR_PROFILE ]; then
        mkdir -p priv/bin/default
        cp _build/default/lib/riak/rel/riak/bin/* priv/bin/default/
    else
        mkdir -p priv/bin/$REBAR_PROFILE
        cp _build/$REBAR_PROFILE/lib/riak/rel/riak/bin/* priv/bin/$REBAR_PROFILE/
    fi
    echo "Post compile hook: Success!"
fi
REBAR_DEPS_DIR=$OLD_DEPS_DIR
REBAR_BUILD_DIR=$OLD_BUILD_DIR
